{% extends 'dashboard/base.html' %}
{% load i18n %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}
{% if product %}
{% trans 'تعديل المنتج' %}: {{ product.name }}
{% else %}
{% trans 'إضافة منتج جديد' %}
{% endif %}
{% endblock %}

{% block page_title %}
{% if product %}
{% trans 'تعديل المنتج' %}
{% else %}
{% trans 'إضافة منتج جديد' %}
{% endif %}
{% endblock %}

{% block current_page %}
{% if product %}
{{ product.name }}
{% else %}
{% trans 'منتج جديد' %}
{% endif %}
{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{% url 'dashboard:dashboard_products' %}">{% trans 'المنتجات' %}</a></li>
{% if product %}
<li class="breadcrumb-item"><a href="{% url 'dashboard:dashboard_product_detail' product_id=product.id %}">{{ product.name }}</a></li>
{% endif %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.20/summernote-bs5.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.css">
<style>
    .form-section {
        border-bottom: 1px solid #eee;
        padding-bottom: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .form-section:last-child {
        border-bottom: none;
    }
    .form-section-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #333;
    }
    .image-preview-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    .image-preview-item {
        position: relative;
        width: 120px;
        height: 120px;
        border-radius: 0.25rem;
        overflow: hidden;
        border: 2px solid #dee2e6;
        transition: all 0.3s ease;
    }
    .image-preview-item:hover {
        border-color: var(--bs-primary);
    }
    .image-preview-item.is-primary {
        border-color: var(--bs-primary);
    }
    .image-preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .image-preview-actions {
        position: absolute;
        top: 0;
        right: 0;
        padding: 0.25rem;
        display: flex;
        gap: 0.25rem;
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 0 0 0 0.25rem;
    }
    [dir="rtl"] .image-preview-actions {
        right: auto;
        left: 0;
        border-radius: 0 0 0.25rem 0;
    }
    .image-preview-actions button {
        padding: 0;
        width: 1.5rem;
        height: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.25rem;
        border: none;
        background-color: transparent;
    }
    .image-preview-actions button:hover {
        background-color: rgba(0, 0, 0, 0.1);
    }
    .image-preview-badge {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 0.25rem;
        background-color: rgba(0, 0, 0, 0.6);
        color: #fff;
        text-align: center;
        font-size: 0.75rem;
    }
    .image-preview-placeholder {
        width: 120px;
        height: 120px;
        border-radius: 0.25rem;
        border: 2px dashed #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .image-preview-placeholder:hover {
        border-color: var(--bs-primary);
        color: var(--bs-primary);
    }
    .tab-pane {
        padding: 1.5rem;
    }
    .bootstrap-tagsinput {
        width: 100%;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
        color: #212529;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid #ced4da;
        appearance: none;
        border-radius: 0.25rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    .bootstrap-tagsinput .tag {
        margin-right: 2px;
        padding: 0.25em 0.4em;
        font-size: 0.875em;
        font-weight: 700;
        color: #fff;
        background-color: var(--bs-primary);
        border-radius: 0.25rem;
        display: inline-block;
    }
    [dir="rtl"] .bootstrap-tagsinput .tag {
        margin-right: 0;
        margin-left: 2px;
    }
    .bootstrap-tagsinput .tag [data-role="remove"] {
        margin-left: 8px;
        cursor: pointer;
    }
    [dir="rtl"] .bootstrap-tagsinput .tag [data-role="remove"] {
        margin-left: 0;
        margin-right: 8px;
    }
    .bootstrap-tagsinput .tag [data-role="remove"]:after {
        content: "×";
        padding: 0 2px;
    }
    .form-check-lg {
        padding-left: 2rem;
    }
    [dir="rtl"] .form-check-lg {
        padding-left: 0;
        padding-right: 2rem;
    }
    .form-check-lg .form-check-input {
        width: 1.5rem;
        height: 1.5rem;
        margin-top: 0;
        margin-left: -2rem;
    }
    [dir="rtl"] .form-check-lg .form-check-input {
        margin-left: 0;
        margin-right: -2rem;
    }
    .form-check-lg .form-check-label {
        padding-top: 0.25rem;
    }
    .price-field .input-group-text {
        background-color: #f8f9fa;
    }
    .select2-container--default .select2-selection--multiple {
        border: 1px solid #ced4da;
    }
    .select2-container--default.select2-container--focus .select2-selection--multiple {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    .specifications-editor, .features-editor {
        min-height: 200px;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        padding: 0.5rem;
        font-family: monospace;
    }
    .note-editor .note-editing-area .note-editable {
        min-height: 200px;
    }
    .sticky-submit {
        position: sticky;
        bottom: 1rem;
        z-index: 1000;
        background-color: #fff;
        box-shadow: 0 -5px 10px rgba(0, 0, 0, 0.1);
        border-radius: 0.25rem;
        padding: 1rem;
    }
    .form-control-color {
        width: 3rem;
    }
    .variant-attributes-table {
        border-collapse: collapse;
        width: 100%;
    }
    .variant-attributes-table td {
        padding: 0.5rem;
        vertical-align: middle;
    }
    .variant-attributes-table td:first-child {
        font-weight: 600;
        width: 30%;
    }
    .seo-preview {
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 1rem;
        margin-top: 1rem;
        background-color: #f8f9fa;
    }
    .seo-preview-title {
        color: #1a0dab;
        font-size: 1.25rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .seo-preview-url {
        color: #006621;
        font-size: 0.875rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .seo-preview-description {
        color: #545454;
        font-size: 0.875rem;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }
</style>
{% endblock %}

{% block content %}
<form method="post" enctype="multipart/form-data" id="product-form">
    {% csrf_token %}

    <div class="row">
        <div class="col-lg-9">
            <!-- البطاقة الرئيسية -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <ul class="nav nav-tabs card-header-tabs" id="productTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link active" id="basic-tab" data-bs-toggle="tab" href="#basic" role="tab" aria-controls="basic" aria-selected="true">
                                <i class="fa fa-info-circle me-1"></i> {% trans 'المعلومات الأساسية' %}
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="images-tab" data-bs-toggle="tab" href="#images" role="tab" aria-controls="images" aria-selected="false">
                                <i class="fa fa-images me-1"></i> {% trans 'الصور' %}
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="pricing-tab" data-bs-toggle="tab" href="#pricing" role="tab" aria-controls="pricing" aria-selected="false">
                                <i class="fa fa-tag me-1"></i> {% trans 'التسعير والمخزون' %}
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="description-tab" data-bs-toggle="tab" href="#description" role="tab" aria-controls="description" aria-selected="false">
                                <i class="fa fa-file-alt me-1"></i> {% trans 'الوصف' %}
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="specifications-tab" data-bs-toggle="tab" href="#specifications" role="tab" aria-controls="specifications" aria-selected="false">
                                <i class="fa fa-clipboard-list me-1"></i> {% trans 'المواصفات' %}
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="seo-tab" data-bs-toggle="tab" href="#seo" role="tab" aria-controls="seo" aria-selected="false">
                                <i class="fa fa-search me-1"></i> {% trans 'SEO' %}
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="card-body p-0">
                    <div class="tab-content" id="productTabsContent">
                        <!-- المعلومات الأساسية -->
                        <div class="tab-pane fade show active" id="basic" role="tabpanel" aria-labelledby="basic-tab">
                            <div class="form-section">
                                <h5 class="form-section-title">{% trans 'معلومات المنتج الأساسية' %}</h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="name" class="form-label">{% trans 'اسم المنتج' %} <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="name" name="name" value="{{ product.name|default:'' }}" required>
                                        <div class="form-text">{% trans 'اسم المنتج الرئيسي (باللغة العربية)' %}</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="name_en" class="form-label">{% trans 'اسم المنتج (الإنجليزية)' %}</label>
                                        <input type="text" class="form-control" id="name_en" name="name_en" value="{{ product.name_en|default:'' }}" dir="ltr">
                                        <div class="form-text">{% trans 'اسم المنتج باللغة الإنجليزية (اختياري)' %}</div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="sku" class="form-label">{% trans 'رقم المنتج (SKU)' %}</label>
                                        <input type="text" class="form-control" id="sku" name="sku" value="{{ product.sku|default:'' }}" dir="ltr">
                                        <div class="form-text">{% trans 'رقم تعريف المنتج الفريد' %}</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="barcode" class="form-label">{% trans 'الباركود' %}</label>
                                        <input type="text" class="form-control" id="barcode" name="barcode" value="{{ product.barcode|default:'' }}" dir="ltr">
                                        <div class="form-text">{% trans 'رمز الباركود مثل UPC أو EAN (اختياري)' %}</div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="category" class="form-label">{% trans 'الفئة' %} <span class="text-danger">*</span></label>
                                        <select class="form-select select2" id="category" name="category" required>
                                            <option value="">{% trans 'اختر الفئة...' %}</option>
                                            {% for category in categories %}
                                                <option value="{{ category.id }}" {% if product.category_id == category.id %}selected{% endif %}>
                                                    {{ category.name }}
                                                </option>
                                                {% if category.children.exists %}
                                                    {% for child in category.children.all %}
                                                        <option value="{{ child.id }}" {% if product.category_id == child.id %}selected{% endif %}>
                                                            &nbsp;&nbsp;— {{ child.name }}
                                                        </option>
                                                        {% if child.children.exists %}
                                                            {% for grandchild in child.children.all %}
                                                                <option value="{{ grandchild.id }}" {% if product.category_id == grandchild.id %}selected{% endif %}>
                                                                    &nbsp;&nbsp;&nbsp;&nbsp;— {{ grandchild.name }}
                                                                </option>
                                                            {% endfor %}
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="brand" class="form-label">{% trans 'العلامة التجارية' %}</label>
                                        <select class="form-select select2" id="brand" name="brand">
                                            <option value="">{% trans 'بدون علامة تجارية' %}</option>
                                            {% for brand in brands %}
                                                <option value="{{ brand.id }}" {% if product.brand_id == brand.id %}selected{% endif %}>
                                                    {{ brand.name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h5 class="form-section-title">{% trans 'الوسوم والتصنيفات' %}</h5>
                                <div class="mb-3">
                                    <label for="tags" class="form-label">{% trans 'الوسوم' %}</label>
                                    <select class="form-select select2" id="tags" name="tags" multiple>
                                        {% for tag in tags %}
                                            <option value="{{ tag.id }}" {% if product and tag in product.tags.all %}selected{% endif %}>
                                                {{ tag.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <div class="form-text">{% trans 'اختر الوسوم المرتبطة بالمنتج' %}</div>
                                </div>
                                <div class="mb-3">
                                    <label for="search_keywords" class="form-label">{% trans 'كلمات البحث' %}</label>
                                    <textarea class="form-control" id="search_keywords" name="search_keywords" rows="2">{{ product.search_keywords|default:'' }}</textarea>
                                    <div class="form-text">{% trans 'كلمات مفتاحية تساعد في ظهور المنتج في نتائج البحث (مفصولة بفواصل أو مسافات)' %}</div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h5 class="form-section-title">{% trans 'إعدادات المنتج' %}</h5>
                                <div class="row mb-3">
                                    <div class="col-md-6 mb-3">
                                        <label for="status" class="form-label">{% trans 'حالة المنتج' %}</label>
                                        <select class="form-select" id="status" name="status">
                                            {% for status_code, status_name in status_choices %}
                                                <option value="{{ status_code }}" {% if product.status == status_code %}selected{% endif %}>
                                                    {{ status_name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                        <div class="form-text">
                                            {% trans 'المنتجات المنشورة ستظهر مباشرةً في الموقع' %}
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="condition" class="form-label">{% trans 'حالة المنتج الفعلية' %}</label>
                                        <select class="form-select" id="condition" name="condition">
                                            {% for condition_code, condition_name in condition_choices %}
                                                <option value="{{ condition_code }}" {% if product.condition == condition_code %}selected{% endif %}>
                                                    {{ condition_name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <div class="form-check form-check-lg">
                                            <input class="form-check-input" type="checkbox" id="is_active" name="is_active" {% if product.is_active %}checked{% endif %}>
                                            <label class="form-check-label" for="is_active">
                                                {% trans 'منتج نشط' %}
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <div class="form-check form-check-lg">
                                            <input class="form-check-input" type="checkbox" id="is_featured" name="is_featured" {% if product.is_featured %}checked{% endif %}>
                                            <label class="form-check-label" for="is_featured">
                                                {% trans 'منتج مميز' %}
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <div class="form-check form-check-lg">
                                            <input class="form-check-input" type="checkbox" id="is_new" name="is_new" {% if product.is_new %}checked{% endif %}>
                                            <label class="form-check-label" for="is_new">
                                                {% trans 'منتج جديد' %}
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <div class="form-check form-check-lg">
                                            <input class="form-check-input" type="checkbox" id="is_best_seller" name="is_best_seller" {% if product.is_best_seller %}checked{% endif %}>
                                            <label class="form-check-label" for="is_best_seller">
                                                {% trans 'الأكثر مبيعاً' %}
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <div class="form-check form-check-lg">
                                            <input class="form-check-input" type="checkbox" id="is_digital" name="is_digital" {% if product.is_digital %}checked{% endif %}>
                                            <label class="form-check-label" for="is_digital">
                                                {% trans 'منتج رقمي' %}
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <div class="form-check form-check-lg">
                                            <input class="form-check-input" type="checkbox" id="requires_shipping" name="requires_shipping" {% if product.requires_shipping %}checked{% endif %}>
                                            <label class="form-check-label" for="requires_shipping">
                                                {% trans 'يتطلب شحن' %}
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <div class="form-check form-check-lg">
                                            <input class="form-check-input" type="checkbox" id="allow_reviews" name="allow_reviews" {% if product.allow_reviews %}checked{% endif %}>
                                            <label class="form-check-label" for="allow_reviews">
                                                {% trans 'السماح بالتقييمات' %}
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- الصور -->
                        <div class="tab-pane fade" id="images" role="tabpanel" aria-labelledby="images-tab">
                            <div class="form-section">
                                <h5 class="form-section-title">{% trans 'صور المنتج' %}</h5>
                                <p>{% trans 'أضف صوراً عالية الجودة للمنتج. الصورة الأولى ستكون الصورة الرئيسية.' %}</p>

                                <div class="image-preview-container">
                                    <!-- الصور الحالية -->
                                    {% for image in images %}
                                    <div class="image-preview-item {% if image.is_primary %}is-primary{% endif %}">
                                        <img src="{{ image.image.url }}" alt="{{ image.alt_text|default:product.name }}">
                                        <div class="image-preview-actions">
                                            <button type="button" class="btn-make-primary" data-image-id="{{ image.id }}" title="{% trans 'تعيين كصورة رئيسية' %}">
                                                <i class="fa fa-star {% if image.is_primary %}text-warning{% else %}text-muted{% endif %}"></i>
                                            </button>
                                            <button type="button" class="btn-remove-image" data-image-id="{{ image.id }}" title="{% trans 'حذف الصورة' %}">
                                                <i class="fa fa-trash text-danger"></i>
                                            </button>
                                        </div>
                                        {% if image.is_primary %}
                                        <div class="image-preview-badge">{% trans 'الصورة الرئيسية' %}</div>
                                        {% endif %}
                                        <input type="hidden" name="image_ids[]" value="{{ image.id }}">
                                        <input type="hidden" name="primary_image" id="primary_image" value="{{ image.id|default:'' }}">
                                    </div>
                                    {% endfor %}

                                    <!-- زر إضافة صورة جديدة -->
                                    <div class="image-preview-placeholder" id="add-image-btn">
                                        <div class="text-center">
                                            <i class="fa fa-plus fa-2x mb-2"></i>
                                            <div>{% trans 'إضافة صورة' %}</div>
                                        </div>
                                    </div>
                                </div>

                                <input type="file" id="product_images" name="product_images" multiple accept="image/*" class="d-none">

                                <div class="alert alert-info mt-3">
                                    <i class="fa fa-info-circle me-2"></i>
                                    {% trans 'للحصول على أفضل النتائج، استخدم صور بدقة عالية (على الأقل 800×800 بكسل) بخلفية بيضاء.' %}
                                </div>
                            </div>

                            <div class="form-section">
                                <h5 class="form-section-title">{% trans 'الفيديو والمعرض ثلاثي الأبعاد' %}</h5>
                                <div class="mb-3">
                                    <label for="video_url" class="form-label">{% trans 'رابط الفيديو' %}</label>
                                    <input type="url" class="form-control" id="video_url" name="video_url" value="{{ product.video_url|default:'' }}" dir="ltr">
                                    <div class="form-text">
                                        {% trans 'يمكنك إضافة رابط فيديو من YouTube أو Vimeo (اختياري)' %}
                                    </div>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="has_360_view" name="has_360_view" {% if product.has_360_view %}checked{% endif %}>
                                    <label class="form-check-label" for="has_360_view">
                                        {% trans 'تفعيل العرض ثلاثي الأبعاد (360 درجة)' %}
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- التسعير والمخزون -->
                        <div class="tab-pane fade" id="pricing" role="tabpanel" aria-labelledby="pricing-tab">
                            <div class="form-section">
                                <h5 class="form-section-title">{% trans 'التسعير' %}</h5>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="base_price" class="form-label">{% trans 'السعر الأساسي' %} <span
                                                class="text-danger">*</span></label>
                                        <div class="input-group price-field">
                                            <input type="number" class="form-control" id="base_price" name="base_price"
                                                   step="0.01" min="0" value="0.00" required>
                                            <span class="input-group-text">د.ا</span>
                                        </div>
                                        <div class="form-text">{% trans 'السعر الحالي للمنتج' %}</div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="compare_price" class="form-label">{% trans 'سعر المقارنة' %}</label>
                                        <div class="input-group price-field">
                                            <input type="number" class="form-control" id="compare_price" name="compare_price" step="0.01" min="0" value="{{ product.compare_price|default:'' }}">
                                            <span class="input-group-text">د.ا</span>
                                        </div>
                                        <div class="form-text">{% trans 'السعر القديم أو الأصلي قبل الخصم' %}</div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="cost" class="form-label">{% trans 'التكلفة' %}</label>
                                        <div class="input-group price-field">
                                            <input type="number" class="form-control" id="cost" name="cost" step="0.01" min="0" value="{{ product.cost|default:'' }}">
                                            <span class="input-group-text">د.ا</span>
                                        </div>
                                        <div class="form-text">{% trans 'تكلفة المنتج (للاستخدام الداخلي)' %}</div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="tax_rate" class="form-label">{% trans 'نسبة الضريبة (%)' %}</label>
                                        <input type="number" class="form-control" id="tax_rate" name="tax_rate" step="0.01" min="0" max="100" value="{{ product.tax_rate|default:'16' }}">
                                        <div class="form-text">{% trans 'نسبة ضريبة القيمة المضافة (16% افتراضياً)' %}</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="tax_class" class="form-label">{% trans 'فئة الضريبة' %}</label>
                                        <input type="text" class="form-control" id="tax_class" name="tax_class" value="{{ product.tax_class|default:'' }}">
                                        <div class="form-text">{% trans 'فئة الضريبة المطبقة على المنتج (اختياري)' %}</div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h5 class="form-section-title">{% trans 'المخزون' %}</h5>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="stock_quantity" class="form-label">{% trans 'الكمية المتوفرة' %}</label>
                                        <input type="number" class="form-control" id="stock_quantity" name="stock_quantity" min="0" value="{{ product.stock_quantity|default:'0' }}">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="stock_status" class="form-label">{% trans 'حالة المخزون' %}</label>
                                        <select class="form-select" id="stock_status" name="stock_status">
                                            {% for status_code, status_name in stock_status_choices %}
                                                <option value="{{ status_code }}" {% if product.stock_status == status_code %}selected{% endif %}>
                                                    {{ status_name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="min_stock_level" class="form-label">{% trans 'الحد الأدنى للمخزون' %}</label>
                                        <input type="number" class="form-control" id="min_stock_level" name="min_stock_level" min="0" value="{{ product.min_stock_level|default:'5' }}">
                                        <div class="form-text">{% trans 'سيتم التنبيه عند انخفاض المخزون عن هذا الحد' %}</div>
                                    </div>
                                </div>

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="track_inventory" name="track_inventory" {% if product.track_inventory %}checked{% endif %}>
                                    <label class="form-check-label" for="track_inventory">
                                        {% trans 'تتبع المخزون' %}
                                    </label>
                                </div>
                            </div>

                            <div class="form-section">
                                <h5 class="form-section-title">{% trans 'الأبعاد والشحن' %}</h5>
                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <label for="weight" class="form-label">{% trans 'الوزن (كجم)' %}</label>
                                        <input type="number" class="form-control" id="weight" name="weight" step="0.001" min="0" value="{{ product.weight|default:'' }}">
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="length" class="form-label">{% trans 'الطول (سم)' %}</label>
                                        <input type="number" class="form-control" id="length" name="length" step="0.01" min="0" value="{{ product.length|default:'' }}">
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="width" class="form-label">{% trans 'العرض (سم)' %}</label>
                                        <input type="number" class="form-control" id="width" name="width" step="0.01" min="0" value="{{ product.width|default:'' }}">
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="height" class="form-label">{% trans 'الارتفاع (سم)' %}</label>
                                        <input type="number" class="form-control" id="height" name="height" step="0.01" min="0" value="{{ product.height|default:'' }}">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- الوصف -->
                        <div class="tab-pane fade" id="description" role="tabpanel" aria-labelledby="description-tab">
                            <div class="form-section">
                                <h5 class="form-section-title">{% trans 'وصف المنتج' %}</h5>
                                <div class="mb-3">
                                    <label for="short_description" class="form-label">{% trans 'الوصف المختصر' %}</label>
                                    <textarea class="form-control" id="short_description" name="short_description" rows="3">{{ product.short_description|default:'' }}</textarea>
                                    <div class="form-text">{% trans 'وصف مختصر يظهر في قوائم المنتجات ونتائج البحث (لا يتجاوز 160 حرفاً)' %}</div>
                                </div>
                                <div class="mb-3">
                                    <label for="description" class="form-label">{% trans 'الوصف الكامل' %}</label>
                                    <textarea class="form-control rich-text-editor" id="description" name="description" rows="10">{{ product.description|default:'' }}</textarea>
                                    <div class="form-text">{% trans 'وصف تفصيلي للمنتج. يمكنك إضافة صور ونصوص منسقة' %}</div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h5 class="form-section-title">{% trans 'ميزات المنتج' %}</h5>
                                <div class="mb-3">
                                    <label for="features" class="form-label">{% trans 'ميزات المنتج' %}</label>
                                    <textarea class="form-control features-editor" id="features" name="features" rows="5">{{ features_json|default:'' }}</textarea>
                                    <div class="form-text">{% trans 'أدخل ميزات المنتج (فائدة واحدة في كل سطر أو استخدم صيغة JSON)' %}</div>
                                </div>
                            </div>
                        </div>

                        <!-- المواصفات -->
                        <div class="tab-pane fade" id="specifications" role="tabpanel" aria-labelledby="specifications-tab">
                            <div class="form-section">
                                <h5 class="form-section-title">{% trans 'المواصفات الفنية' %}</h5>
                                <div class="mb-3">
                                    <label for="specifications" class="form-label">{% trans 'المواصفات' %}</label>
                                    <textarea class="form-control specifications-editor" id="specifications" name="specifications_json" rows="10">{{ specifications_json|default:'' }}</textarea>
                                    <div class="form-text">{% trans 'أدخل المواصفات الفنية للمنتج بتنسيق JSON' %}</div>
                                </div>
                                <div class="alert alert-info">
                                    <i class="fa fa-info-circle me-2"></i>
                                    {% trans 'استخدم تنسيق JSON لإدخال المواصفات، على سبيل المثال:' %}
                                    <pre class="mt-2 bg-light p-2 rounded">
{
    "الشاشة": "6.1 بوصة، Super Retina XDR",
    "الذاكرة": "128 جيجابايت",
    "المعالج": "A15 Bionic",
    "الكاميرا": "ثنائية العدسة، 12 ميجابكسل"
}</pre>
                                </div>
                            </div>

                            <div class="form-section">
                                <h5 class="form-section-title">{% trans 'خصائص إضافية' %}</h5>
                                <div class="mb-3">
                                    <label class="form-label">{% trans 'خصائص المنتج' %}</label>

                                    {% if attributes %}
                                    <table class="table table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th>{% trans 'الخاصية' %}</th>
                                                <th>{% trans 'القيمة' %}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for attribute in product_attributes %}
                                            <tr>
                                                <td>{{ attribute.name }}</td>
                                                <td>
                                                    {% if attribute.attribute_type == 'text' %}
                                                    <input type="text" class="form-control" name="attribute_{{ attribute.id }}" value="{{ attribute.value|default:'' }}">
                                                    {% elif attribute.attribute_type == 'number' %}
                                                    <input type="number" class="form-control" name="attribute_{{ attribute.id }}" value="{{ attribute.value|default:'' }}">
                                                    {% elif attribute.attribute_type == 'boolean' %}
                                                    <select class="form-select" name="attribute_{{ attribute.id }}">
                                                        <option value="">{% trans 'اختر...' %}</option>
                                                        <option value="true" {% if attribute.value == 'true' %}selected{% endif %}>{% trans 'نعم' %}</option>
                                                        <option value="false" {% if attribute.value == 'false' %}selected{% endif %}>{% trans 'لا' %}</option>
                                                    </select>
                                                    {% elif attribute.attribute_type == 'select' %}
                                                    <select class="form-select" name="attribute_{{ attribute.id }}">
                                                        <option value="">{% trans 'اختر...' %}</option>
                                                        {% for option in attribute.options %}
                                                        <option value="{{ option }}" {% if attribute.value == option %}selected{% endif %}>{{ option }}</option>
                                                        {% endfor %}
                                                    </select>
                                                    {% elif attribute.attribute_type == 'multiselect' %}
                                                    <select class="form-select" name="attribute_{{ attribute.id }}" multiple>
                                                        {% for option in attribute.options %}
                                                        <option value="{{ option }}" {% if option in attribute.value %}selected{% endif %}>{{ option }}</option>
                                                        {% endfor %}
                                                    </select>
                                                    {% elif attribute.attribute_type == 'color' %}
                                                    <input type="color" class="form-control form-control-color" name="attribute_{{ attribute.id }}" value="{{ attribute.value|default:'#000000' }}">
                                                    {% elif attribute.attribute_type == 'date' %}
                                                    <input type="date" class="form-control" name="attribute_{{ attribute.id }}" value="{{ attribute.value|default:'' }}">
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    {% else %}
                                    <div class="alert alert-light text-center">
                                        <i class="fa fa-info-circle me-2"></i>
                                        {% trans 'لا توجد خصائص متاحة لهذه الفئة.' %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- SEO -->
                        <div class="tab-pane fade" id="seo" role="tabpanel" aria-labelledby="seo-tab">
                            <div class="form-section">
                                <h5 class="form-section-title">{% trans 'تحسين محركات البحث (SEO)' %}</h5>
                                <div class="mb-3">
                                    <label for="meta_title" class="form-label">{% trans 'عنوان SEO' %}</label>
                                    <input type="text" class="form-control" id="meta_title" name="meta_title" value="{{ product.meta_title|default:'' }}">
                                    <div class="form-text">{% trans 'عنوان الصفحة الذي سيظهر في نتائج البحث (60-70 حرف)' %}</div>
                                </div>
                                <div class="mb-3">
                                    <label for="meta_description" class="form-label">{% trans 'وصف SEO' %}</label>
                                    <textarea class="form-control" id="meta_description" name="meta_description" rows="3">{{ product.meta_description|default:'' }}</textarea>
                                    <div class="form-text">{% trans 'وصف مختصر للصفحة الذي سيظهر في نتائج البحث (150-160 حرف)' %}</div>
                                </div>
                                <div class="mb-3">
                                    <label for="meta_keywords" class="form-label">{% trans 'الكلمات المفتاحية' %}</label>
                                    <input type="text" class="form-control" id="meta_keywords" name="meta_keywords" value="{{ product.meta_keywords|default:'' }}">
                                    <div class="form-text">{% trans 'الكلمات المفتاحية مفصولة بفواصل' %}</div>
                                </div>

                                <div class="seo-preview">
                                    <h6>{% trans 'معاينة ظهور الصفحة في محركات البحث:' %}</h6>
                                    <div class="seo-preview-title" id="seo-preview-title">
                                        {% if product %}{{ product.meta_title|default:product.name }}{% else %}عنوان المنتج{% endif %}
                                    </div>
                                    <div class="seo-preview-url">
                                        www.example.com/products/{{ product.slug|default:'product-name' }}
                                    </div>
                                    <div class="seo-preview-description" id="seo-preview-description">
                                        {% if product %}{{ product.meta_description|default:product.short_description }}{% else %}وصف المنتج سيظهر هنا. قم بإضافة وصف مختصر وجذاب للمنتج.{% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h5 class="form-section-title">{% trans 'وسائل التواصل الاجتماعي' %}</h5>
                                <div class="mb-3">
                                    <label for="social_title" class="form-label">{% trans 'عنوان المشاركة' %}</label>
                                    <input type="text" class="form-control" id="social_title" name="social_title" value="{{ product.social_title|default:'' }}">
                                    <div class="form-text">{% trans 'عنوان المشاركة في وسائل التواصل الاجتماعي (اختياري)' %}</div>
                                </div>
                                <div class="mb-3">
                                    <label for="social_description" class="form-label">{% trans 'وصف المشاركة' %}</label>
                                    <textarea class="form-control" id="social_description" name="social_description" rows="3">{{ product.social_description|default:'' }}</textarea>
                                    <div class="form-text">{% trans 'وصف المشاركة في وسائل التواصل الاجتماعي (اختياري)' %}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- زر الحفظ الثابت -->
            <div class="sticky-submit">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fa fa-save me-1"></i>
                            {% if product %}
                                {% trans 'حفظ التغييرات' %}
                            {% else %}
                                {% trans 'إنشاء المنتج' %}
                            {% endif %}
                        </button>
                        <button type="submit" name="save_and_continue" value="1" class="btn btn-outline-primary ms-2">
                            <i class="fa fa-save me-1"></i> {% trans 'حفظ ومتابعة التعديل' %}
                        </button>
                    </div>
                    <a href="{% url 'dashboard:dashboard_products' %}" class="btn btn-outline-secondary">
                        <i class="fa fa-times me-1"></i> {% trans 'إلغاء' %}
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-3">
            <!-- حالة الحفظ -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">{% trans 'حالة المنتج' %}</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="status_switch" {% if product.status == 'published' %}checked{% endif %}>
                            <label class="form-check-label" for="status_switch">
                                <span id="status_label">
                                    {% if product.status == 'published' %}
                                        <i class="fa fa-eye text-success me-1"></i> {% trans 'منشور' %}
                                    {% else %}
                                        <i class="fa fa-eye-slash text-secondary me-1"></i> {% trans 'مسودة' %}
                                    {% endif %}
                                </span>
                            </label>
                        </div>

                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="visibility_switch" {% if product.is_active %}checked{% endif %}>
                            <label class="form-check-label" for="visibility_switch">
                                <span id="visibility_label">
                                    {% if product.is_active %}
                                        <i class="fa fa-check-circle text-success me-1"></i> {% trans 'نشط' %}
                                    {% else %}
                                        <i class="fa fa-ban text-danger me-1"></i> {% trans 'غير نشط' %}
                                    {% endif %}
                                </span>
                            </label>
                        </div>
                    </div>

                    <hr>

                    <div class="mb-3">
                        {% if product %}
                        <div class="text-muted mb-2">
                            <small>
                                <i class="fa fa-calendar me-1"></i> {% trans 'تاريخ الإنشاء:' %} {{ product.created_at|date:"Y/m/d H:i" }}
                            </small>
                        </div>
                        <div class="text-muted mb-2">
                            <small>
                                <i class="fa fa-edit me-1"></i> {% trans 'آخر تحديث:' %} {{ product.updated_at|date:"Y/m/d H:i" }}
                            </small>
                        </div>
                        {% if product.published_at %}
                        <div class="text-muted">
                            <small>
                                <i class="fa fa-globe me-1"></i> {% trans 'تاريخ النشر:' %} {{ product.published_at|date:"Y/m/d H:i" }}
                            </small>
                        </div>
                        {% endif %}
                        {% else %}
                        <div class="text-muted">
                            <small>
                                <i class="fa fa-info-circle me-1"></i> {% trans 'سيتم إنشاء المنتج بعد الحفظ' %}
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- الإجراءات السريعة -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">{% trans 'إجراءات سريعة' %}</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if product %}
                        <a href="#" class="btn btn-outline-primary">
                            <i class="fa fa-eye me-1"></i> {% trans 'معاينة المنتج' %}
                        </a>
                        <a href="#" class="btn btn-outline-secondary">
                            <i class="fa fa-clone me-1"></i> {% trans 'نسخ المنتج' %}
                        </a>
                        <a href="#" class="btn btn-outline-info">
                            <i class="fa fa-plus-circle me-1"></i> {% trans 'إضافة متغير' %}
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- المنتجات ذات الصلة -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">{% trans 'المنتجات ذات الصلة' %}</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="related_products" class="form-label">{% trans 'المنتجات ذات الصلة' %}</label>
                        <select class="form-select select2" id="related_products" name="related_products" multiple>
                            {% for related_product in related_products %}
                                <option value="{{ related_product.id }}" selected>{{ related_product.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">{% trans 'اختر المنتجات التي ستظهر في قسم "منتجات ذات صلة"' %}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.20/summernote-bs5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.min.js"></script>
<script>
    $(document).ready(function() {

        // التأكد من أن حقول الأسعار تحتوي على قيم صالحة دائمًا
    function ensureValidNumericFields() {
        // تعيين قيمة افتراضية لحقل السعر الأساسي إذا كان فارغًا أو صفر
        let basePrice = $('#base_price').val();
        if (!basePrice || parseFloat(basePrice) <= 0) {
            $('#base_price').val('0.01');  // تغيير من 0.00 إلى 0.01
        }

        // تعيين قيم افتراضية للحقول العددية الأخرى إذا كانت مطلوبة ولكنها فارغة
        if ($('#tax_rate').prop('required') && !$('#tax_rate').val()) {
            $('#tax_rate').val('16.00');
        }

        // معالجة الحقول العددية الأخرى
        $('input[type="number"]').each(function() {
            // إذا كان الحقل مطلوبًا ولكنه فارغ، نضع فيه قيمة افتراضية
            if ($(this).prop('required') && !$(this).val()) {
                if ($(this).attr('step') === '0.01') {
                    // حقل عشري
                    $(this).val('0.00');
                } else {
                    // حقل عدد صحيح
                    $(this).val('0');
                }
            }
        });
    }

    // تنفيذ التحقق عند تحميل الصفحة
    ensureValidNumericFields();

        // تهيئة حقول Select2
        $('.select2').select2({
            dir: $('html').attr('dir'),
            placeholder: "{% trans 'اختر...' %}",
            allowClear: true,
            width: '100%'
        });

        // تهيئة محرر Summernote
        $('.rich-text-editor').summernote({
            height: 300,
            toolbar: [
                ['style', ['style']],
                ['font', ['bold', 'underline', 'clear']],
                ['color', ['color']],
                ['para', ['ul', 'ol', 'paragraph']],
                ['table', ['table']],
                ['insert', ['link', 'picture']],
                ['view', ['fullscreen', 'codeview', 'help']]
            ],
            lang: 'ar-AR',
            placeholder: "{% trans 'أدخل وصفاً تفصيلياً للمنتج هنا...' %}"
        });

        // تهيئة حقل الوسوم
        $('#meta_keywords').tagsinput({
            trimValue: true,
            confirmKeys: [13, 44, 32] // Enter, comma, space
        });

        // تحديث معاينة SEO
        $('#meta_title').on('input', function() {
            let title = $(this).val() || $('#name').val() || "{% trans 'عنوان المنتج' %}";
            $('#seo-preview-title').text(title);
        });

        $('#meta_description').on('input', function() {
            let description = $(this).val() || $('#short_description').val() || "{% trans 'وصف المنتج سيظهر هنا. قم بإضافة وصف مختصر وجذاب للمنتج.' %}";
            $('#seo-preview-description').text(description);
        });

        // مؤثرات المفاتيح
        $('#status_switch').change(function() {
            if ($(this).is(':checked')) {
                $('#status').val('published');
                $('#status_label').html('<i class="fa fa-eye text-success me-1"></i> {% trans "منشور" %}');
            } else {
                $('#status').val('draft');
                $('#status_label').html('<i class="fa fa-eye-slash text-secondary me-1"></i> {% trans "مسودة" %}');
            }
        });

        $('#visibility_switch').change(function() {
            if ($(this).is(':checked')) {
                $('#is_active').prop('checked', true);
                $('#visibility_label').html('<i class="fa fa-check-circle text-success me-1"></i> {% trans "نشط" %}');
            } else {
                $('#is_active').prop('checked', false);
                $('#visibility_label').html('<i class="fa fa-ban text-danger me-1"></i> {% trans "غير نشط" %}');
            }
        });

        // إضافة صور جديدة
        $('#add-image-btn').click(function() {
            $('#product_images').click();
        });

        $('#product_images').change(function() {
            if (this.files.length > 0) {
                for (let i = 0; i < this.files.length; i++) {
                    let file = this.files[i];
                    let reader = new FileReader();

                    reader.onload = function(e) {
                        let imagePreview = $('<div class="image-preview-item temp-image"></div>');
                        imagePreview.append('<img src="' + e.target.result + '" alt="Image Preview">');
                        imagePreview.append('<div class="image-preview-actions"><button type="button" class="btn-remove-temp-image" title="{% trans 'حذف' %}"><i class="fa fa-trash text-danger"></i></button></div>');

                        // إضافة الصورة قبل زر الإضافة
                        imagePreview.insertBefore('#add-image-btn');
                    };

                    reader.readAsDataURL(file);
                }
            }
        });

        // حذف الصور المؤقتة
        $(document).on('click', '.btn-remove-temp-image', function() {
            $(this).closest('.temp-image').remove();
        });

        // جعل الصورة رئيسية
        $('.btn-make-primary').click(function() {
            let imageId = $(this).data('image-id');
            $('#primary_image').val(imageId);

            // تحديث واجهة المستخدم
            $('.image-preview-item').removeClass('is-primary');
            $('.image-preview-badge').remove();
            $(this).closest('.image-preview-item').addClass('is-primary');
            $(this).closest('.image-preview-item').append('<div class="image-preview-badge">{% trans "الصورة الرئيسية" %}</div>');

            // تحديث أيقونة النجمة
            $('.btn-make-primary i').removeClass('text-warning').addClass('text-muted');
            $(this).find('i').removeClass('text-muted').addClass('text-warning');
        });

        // حذف الصور الحالية
        $('.btn-remove-image').click(function() {
            if (confirm("{% trans 'هل أنت متأكد من حذف هذه الصورة؟' %}")) {
                let imageId = $(this).data('image-id');
                // هنا يمكن إضافة طلب AJAX لحذف الصورة
                $(this).closest('.image-preview-item').remove();
            }
        });

        // منع إرسال النموذج عند الضغط على Enter
        $(window).keydown(function(event) {
            if (event.keyCode == 13 && event.target.nodeName != 'TEXTAREA') {
                event.preventDefault();
                return false;
            }
        });

        // التحقق من صحة النموذج قبل الإرسال
        $('#product-form').submit(function(event) {
            let isValid = true;
alert('hi')
            // التحقق من الحقول المطلوبة
            if (!$('#name').val()) {
                $('#name').addClass('is-invalid');
                isValid = false;
            }

            let categoryValue = $('#category').val();
        console.log('القيمة المختارة للفئة:', categoryValue);

        if (!categoryValue || categoryValue === '') {
            event.preventDefault();
            alert('يرجى اختيار فئة للمنتج');
            $('#category').select2('open'); // فتح القائمة المنسدلة
            return false;
        }
/*
            if (!$('#category').val()) {
                $('#category').addClass('is-invalid');
                isValid = false;
            }
*/
            // معالجة حقل السعر الأساسي
            let basePrice = $('#base_price').val();
            basePrice = basePrice.replace(',', '.');

            let basePriceNumber = parseFloat(basePrice);
            if (isNaN(basePriceNumber) || basePriceNumber <= 0) {
                alert('السعر الأساسي يجب أن يكون أكبر من صفر');
                $('#base_price').val('0.01');
                $('#base_price').focus();
                return false;
            }

            // تنسيق الرقم ليكون بخانتين عشريتين
            $('#base_price').val(basePriceNumber.toFixed(2));

            // معالجة حقل نسبة الضريبة
            let taxRate = $('#tax_rate').val();
            if (!taxRate || taxRate.trim() === '') {
                // استخدام القيمة الافتراضية إذا كانت فارغة
                $('#tax_rate').val('16.00');
            } else {
                // استبدال الفاصلة بالنقطة
                taxRate = taxRate.replace(',', '.');

                // محاولة تحويل القيمة إلى رقم
                let taxRateNumber = parseFloat(taxRate);
                if (isNaN(taxRateNumber)) {
                    alert('الرجاء إدخال رقم صالح لنسبة الضريبة');
                    $('#tax_rate').focus();
                    return false;
                }

                // تنسيق الرقم ليكون بخانتين عشريتين
                $('#tax_rate').val(taxRateNumber.toFixed(2));
            }

            // معالجة الأسعار الأخرى
            let comparePrice = $('#compare_price').val();
            if (comparePrice && comparePrice.trim() !== '') {
                comparePrice = comparePrice.replace(',', '.');
                let comparePriceNumber = parseFloat(comparePrice);
                if (!isNaN(comparePriceNumber)) {
                    $('#compare_price').val(comparePriceNumber.toFixed(2));
                }
            }

            let cost = $('#cost').val();
            if (cost && cost.trim() !== '') {
                cost = cost.replace(',', '.');
                let costNumber = parseFloat(cost);
                if (!isNaN(costNumber)) {
                    $('#cost').val(costNumber.toFixed(2));
                }
            }

            if (!isValid) {
                event.preventDefault();
                alert("الرجاء ملء جميع الحقول المطلوبة");
                return false;
            }

            // التحقق من تنسيق JSON
            try {
                // التحقق من specifications
                let specs = $('#specifications').val();
                if (specs) {
                    JSON.parse(specs);
                }

                // التحقق من features
                let features = $('#features').val();
                if (features && features.trim().startsWith('{')) {
                    JSON.parse(features);
                }
            } catch (e) {
                event.preventDefault();
                alert("هناك خطأ في تنسيق JSON. الرجاء التحقق من المواصفات والميزات.");
                return false;
            }

            return true;
        });

        ensureValidNumericFields();
        // البحث عن المنتجات ذات الصلة
        $('#related_products').select2({
            dir: $('html').attr('dir'),
            placeholder: "{% trans 'اختر المنتجات ذات الصلة...' %}",
            allowClear: true,
            width: '100%',
            ajax: {
                url: "{% url 'dashboard:dashboard_product_autocomplete' %}",
                dataType: 'json',
                delay: 250,
                data: function(params) {
                    return {
                        q: params.term,
                        page: params.page
                    };
                },
                processResults: function(data, params) {
                    params.page = params.page || 1;
                    return {
                        results: data.results,
                        pagination: {
                            more: data.more
                        }
                    };
                },
                cache: true
            },
            minimumInputLength: 2
        });
    });
</script>
{% endblock %}