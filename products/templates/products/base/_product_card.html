{% load i18n static %}
{% load humanize %}

<!-- File: products/templates/products/base/_product_card.html -->
<!-- بطاقة منتج بتصميم مشابه لموقع أمازون -->

<div class="amazon-product-card">
  <!-- صورة المنتج -->
  <div class="product-image-container">
    <a href="{% url 'products:product_detail' product.slug %}" class="product-link">
      {% if product.default_image %}
        <img src="{{ product.default_image.image.url }}" alt="{{ product.name }}" class="product-image" loading="lazy">
      {% else %}
        <div class="no-image">
          <i class="far fa-image"></i>
        </div>
      {% endif %}
    </a>

    <!-- شارات المنتج (مميز، جديد، إلخ) -->
    <div class="product-badges">
      {% if product.is_new %}
        <span class="badge badge-new">{% trans "جديد" %}</span>
      {% endif %}

      {% if product.is_featured %}
        <span class="badge badge-featured">{% trans "مميز" %}</span>
      {% endif %}

      {% if product.has_discount %}
        <span class="badge badge-discount">-{{ product.discount_percentage }}%</span>
      {% endif %}
    </div>
  </div>

  <div class="product-details">
    <!-- اسم المنتج -->
    <h2 class="product-title">
      <a href="{% url 'products:product_detail' product.slug %}" title="{{ product.name }}">
        {{ product.name|truncatechars:70 }}
      </a>
    </h2>

    <!-- التقييمات والمراجعات -->
    {% if product.rating %}
      <div class="product-rating">
        <div class="stars-container">
          <div class="stars-filled" style="width: {% widthratio product.rating 5 100 %}%;">
            <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
          </div>
          <div class="stars-outline">
            <i class="far fa-star"></i><i class="far fa-star"></i><i class="far fa-star"></i><i class="far fa-star"></i><i class="far fa-star"></i>
          </div>
        </div>
        <a href="{% url 'products:product_detail' product.slug %}#reviews" class="reviews-count">
          {{ product.review_count }}
        </a>
      </div>
    {% endif %}

    <!-- السعر -->
    <div class="product-price">
      {% if product.has_discount %}
        <div class="discount-info">
          <span class="price-before">{{ product.base_price|floatformat:2 }}</span>
        </div>
        <div class="current-price-row">
          <span class="price-now">{{ product.current_price|floatformat:2 }}</span>
          <span class="currency">{% trans "د.أ" %}</span>
        </div>
      {% else %}
        <div class="current-price-row">
          <span class="price-regular">{{ product.current_price|floatformat:2 }}</span>
          <span class="currency">{% trans "د.أ" %}</span>
        </div>
      {% endif %}
    </div>

    <!-- معلومات الشحن -->
    <div class="shipping-info">
      {% if product.free_shipping %}
        <div class="free-shipping">
          <i class="fas fa-check"></i> {% trans "شحن مجاني" %}
        </div>
      {% endif %}

      <!-- حالة المخزون -->
      {% if product.in_stock %}
        {% if product.stock_quantity < 5 and product.stock_quantity > 0 %}
          <div class="low-stock">
            {% trans "متبقي" %} {{ product.stock_quantity }} {% trans "فقط" %}
          </div>
        {% endif %}
      {% else %}
        <div class="out-of-stock">
          {% trans "غير متوفر حالياً" %}
        </div>
      {% endif %}
    </div>

    <!-- زر إضافة للسلة -->
    {% if product.in_stock %}
      <div class="add-to-cart-section">
        <form action="{% url 'cart:add_to_cart' product.id %}" method="post" class="add-to-cart-form">
          {% csrf_token %}
          <input type="hidden" name="product_id" value="{{ product.id }}">
          <input type="hidden" name="quantity" value="1">
          <button type="submit" class="btn-add-cart">
            {% trans "أضف للسلة" %}
          </button>
        </form>
      </div>
    {% endif %}
  </div>
</div>

<style>
/* أسلوب بطاقة المنتج على طراز أمازون */
.amazon-product-card {
  position: relative;
  background-color: #fff;
  border-radius: 4px;
  padding: 10px;
  transition: all 0.2s;
  height: 100%;
  display: flex;
  flex-direction: column;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.amazon-product-card:hover {
  box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
  transform: translateY(-1px);
}

/* حاوية صورة المنتج */
.product-image-container {
  position: relative;
  margin-bottom: 10px;
  height: 200px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 10px;
  background-color: #f8f8f8;
  overflow: hidden;
}

.product-image {
  max-height: 180px;
  max-width: 100%;
  object-fit: contain;
  transition: transform 0.3s ease;
}

.amazon-product-card:hover .product-image {
  transform: scale(1.03);
}

.no-image {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  color: #ccc;
  font-size: 2rem;
}

/* شارات المنتج */
.product-badges {
  position: absolute;
  top: 5px;
  right: 5px;
  display: flex;
  flex-direction: column;
  gap: 5px;
  z-index: 1;
}

.badge {
  padding: 3px 6px;
  font-size: 0.7rem;
  font-weight: 600;
  border-radius: 2px;
}

.badge-new {
  background-color: #007185;
  color: white;
}

.badge-featured {
  background-color: #232f3e;
  color: white;
}

.badge-discount {
  background-color: #cc0c39;
  color: white;
}

/* تفاصيل المنتج */
.product-details {
  display: flex;
  flex-direction: column;
  flex-grow: 1;
}

.product-title {
  font-size: 0.875rem;
  line-height: 1.3;
  margin-bottom: 5px;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  height: 2.6em;
}

.product-title a {
  text-decoration: none;
  color: #0F1111;
}

.product-title a:hover {
  color: #c45500;
  text-decoration: underline;
}

/* التقييمات */
.product-rating {
  display: flex;
  align-items: center;
  margin-bottom: 5px;
}

.stars-container {
  position: relative;
  display: inline-block;
  font-size: 0.8rem;
  width: 80px;
  height: 16px;
}

.stars-outline {
  display: flex;
  color: #ddd;
}

.stars-filled {
  position: absolute;
  top: 0;
  left: 0;
  white-space: nowrap;
  overflow: hidden;
  color: #ffa41c;
  display: flex;
}

.reviews-count {
  margin-left: 5px;
  font-size: 0.8rem;
  color: #007185;
  text-decoration: none;
}

.reviews-count:hover {
  color: #c45500;
  text-decoration: underline;
}

/* السعر */
.product-price {
  margin-bottom: 5px;
}

.discount-info {
  margin-bottom: 2px;
}

.price-before {
  text-decoration: line-through;
  color: #565959;
  font-size: 0.8rem;
}

.current-price-row {
  display: flex;
  align-items: baseline;
}

.price-now {
  color: #cc0c39;
  font-size: 1.15rem;
  font-weight: 700;
}

.price-regular {
  font-size: 1.15rem;
  font-weight: 700;
}

.currency {
  margin-left: 4px;
  font-size: 0.8rem;
  color: #565959;
}

/* معلومات الشحن */
.shipping-info {
  margin-top: 5px;
  margin-bottom: 10px;
  font-size: 0.8rem;
}

.free-shipping {
  color: #007600;
  margin-bottom: 3px;
}

.low-stock {
  color: #cc0c39;
  margin-top: 3px;
}

.out-of-stock {
  color: #cc0c39;
  margin-top: 3px;
  font-weight: 600;
}

/* إضافة للسلة */
.add-to-cart-section {
  margin-top: auto;
}

.btn-add-cart {
  display: block;
  width: 100%;
  padding: 8px 10px;
  background-color: #ffd814;
  border: 1px solid #FCD200;
  border-radius: 20px;
  color: #0F1111;
  font-size: 0.875rem;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 2px 5px rgba(213, 217, 217, 0.5);
}

.btn-add-cart:hover {
  background-color: #f7ca00;
}

/* تصميم متجاوب */
@media (max-width: 767px) {
  .product-image-container {
    height: 180px;
  }

  .product-image {
    max-height: 160px;
  }

  .product-title {
    font-size: 0.8rem;
  }

  .price-now, .price-regular {
    font-size: 1rem;
  }
}

/* دعم اللغة العربية (RTL) */
html[dir="rtl"] .reviews-count {
  margin-left: 0;
  margin-right: 5px;
}

html[dir="rtl"] .currency {
  margin-left: 0;
  margin-right: 4px;
}

html[dir="rtl"] .product-badges {
  right: auto;
  left: 5px;
}
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // معالجة نماذج إضافة المنتج للسلة
    document.querySelectorAll('.add-to-cart-form').forEach(form => {
      form.addEventListener('submit', function(e) {
        e.preventDefault();

        const button = this.querySelector('.btn-add-cart');
        const originalText = button.textContent;

        // تغيير حالة الزر
        button.textContent = '{% trans "جار الإضافة..." %}';
        button.style.opacity = '0.7';

        // إرسال النموذج باستخدام AJAX
        fetch(this.action, {
          method: 'POST',
          body: new FormData(this),
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // تم إضافة المنتج بنجاح
            button.textContent = '{% trans "تمت الإضافة ✓" %}';
            button.style.backgroundColor = '#007600';
            button.style.color = 'white';

            // تحديث عدد المنتجات في السلة (إذا كان موجوداً)
            const cartCountElement = document.querySelector('.cart-count');
            if (cartCountElement) {
              cartCountElement.textContent = data.cart_count || parseInt(cartCountElement.textContent || '0') + 1;
            }

            // إعادة تعيين الزر بعد فترة
            setTimeout(() => {
              button.textContent = originalText;
              button.style.backgroundColor = '';
              button.style.color = '';
              button.style.opacity = '1';
            }, 2000);
          } else {
            // حدث خطأ
            button.textContent = '{% trans "حدث خطأ" %}';

            setTimeout(() => {
              button.textContent = originalText;
              button.style.opacity = '1';
            }, 2000);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          button.textContent = originalText;
          button.style.opacity = '1';
        });
      });
    });
  });
</script>