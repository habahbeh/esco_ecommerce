<!-- File: products/templates/products/category_list.html -->
{% extends 'core/base.html' %}
{% load static %}
{% load i18n %}
{% load cache %}

{% block title %}{% trans "جميع الفئات" %} | {{ site_settings.site_name|default:"ESCO" }}{% endblock %}

{% block meta_description %}{% trans "تصفح جميع فئات المنتجات في متجرنا. اكتشف مجموعة واسعة من المنتجات الصناعية عالية الجودة مصنفة حسب الفئات." %}{% endblock %}
{% block meta_keywords %}فئات, منتجات, تصنيف, صناعي, تجاري{% endblock %}

{% block extra_css %}
<style>
    /* CSS variables from site_settings */
    :root {
        --primary-color: {{ site_settings.primary_color|default:"#0d6efd" }};
        --secondary-color: {{ site_settings.secondary_color|default:"#6c757d" }};
        --accent-color: {{ site_settings.accent_color|default:"#ffc107" }};
        --text-color: {{ site_settings.text_color|default:"#212529" }};
        --bg-color: {{ site_settings.bg_color|default:"#f8f9fa" }};
        --border-color: {{ site_settings.border_color|default:"#dee2e6" }};
    }

    /* Breadcrumb Navigation */
    .breadcrumb-section {
        background-color: var(--bg-color);
        padding: 1.5rem 0;
        border-bottom: 1px solid var(--border-color);
    }

    .breadcrumb-item + .breadcrumb-item::before {
        content: ">";
        color: var(--secondary-color);
    }

    .breadcrumb-title {
        font-size: 1.75rem;
        font-weight: 700;
        margin-top: 1rem;
        color: var(--text-color);
    }

    /* Filter & Sort Bar */
    .filter-sort-bar {
        background: white;
        padding: 1.5rem;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        margin-bottom: 2rem;
        border: 1px solid var(--border-color);
    }

    .filter-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 1rem;
    }

    /* Search Input */
    .search-input-wrapper {
        position: relative;
        flex: 1;
        min-width: 250px;
    }

    .search-input {
        width: 100%;
        padding: 0.8rem 2.5rem 0.8rem 2.5rem;
        border-radius: 10px;
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }

    .search-icon {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--secondary-color);
    }

    .clear-search {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: var(--secondary-color);
        cursor: pointer;
        padding: 0;
        font-size: 0.875rem;
        display: none;
    }

    .search-input:not(:placeholder-shown) + .clear-search {
        display: block;
    }

    /* Sort Options */
    .sort-select {
        padding: 0.8rem 1rem;
        border-radius: 10px;
        border: 1px solid var(--border-color);
        background-color: white;
        min-width: 200px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .sort-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }

    /* View Options */
    .view-options {
        display: flex;
        gap: 0.5rem;
    }

    .view-btn {
        padding: 0.5rem 1rem;
        border: 2px solid var(--border-color);
        background: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        color: var(--secondary-color);
    }

    .view-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    /* Category Grid Enhanced */
    .categories-section {
        padding: 3rem 0 5rem;
    }

    .section-title {
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
        color: var(--text-color);
        position: relative;
        padding-right: 1rem;
    }

    .section-title::before {
        content: '';
        position: absolute;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 5px;
        height: 25px;
        background-color: var(--primary-color);
        border-radius: 5px;
    }

    .categories-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 2rem;
        margin-bottom: 4rem;
    }

    .categories-grid.list-view {
        grid-template-columns: 1fr;
    }

    /* Category Card Enhanced */
    .category-card {
        background: white;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        position: relative;
        height: 100%;
        display: flex;
        flex-direction: column;
        opacity: 0;
        animation: fadeInUp 0.6s ease forwards;
        border: 1px solid var(--border-color);
    }

    .category-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 20px 50px rgba(0,0,0,0.12);
        border-color: var(--primary-color);
    }

    /* List View Styles */
    .categories-grid.list-view .category-card {
        flex-direction: row;
        height: auto;
    }

    .categories-grid.list-view .category-image-wrapper {
        width: 300px;
        height: 200px;
        flex-shrink: 0;
    }

    .categories-grid.list-view .category-content {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        flex: 1;
    }

    /* Image styling */
    .category-image-wrapper {
        position: relative;
        height: 250px;
        overflow: hidden;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }

    .category-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
    }

    .category-card:hover .category-image {
        transform: scale(1.1);
    }

    .category-icon-wrapper {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--primary-color) 0%, rgba(13, 110, 253, 0.7) 100%);
        color: white;
    }

    .category-icon {
        font-size: 5rem;
        transition: all 0.5s ease;
    }

    .category-card:hover .category-icon {
        transform: scale(1.2) rotate(5deg);
    }

    .category-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(to bottom, transparent 0%, rgba(0,0,0,0.7) 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .category-card:hover .category-overlay {
        opacity: 1;
    }

    .category-badge {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: var(--accent-color);
        color: var(--text-color);
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        z-index: 2;
    }

    .view-count-badge {
        position: absolute;
        bottom: 1rem;
        left: 1rem;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        z-index: 2;
    }

    .category-content {
        padding: 2rem;
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .category-name {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .category-icon-inline {
        color: var(--primary-color);
        font-size: 1.25rem;
    }

    .category-description {
        color: var(--secondary-color);
        margin-bottom: 1.5rem;
        flex: 1;
        line-height: 1.6;
    }

    .category-stats {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-color);
    }

    .product-count {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--secondary-color);
        font-size: 0.95rem;
    }

    .product-count i {
        color: var(--primary-color);
    }

    .category-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 600;
        transition: gap 0.3s ease;
    }

    .category-link:hover {
        gap: 1rem;
    }

    /* Empty State Enhanced */
    .empty-state {
        text-align: center;
        padding: 5rem 2rem;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        margin-bottom: 4rem;
    }

    .empty-icon {
        font-size: 5rem;
        color: #dee2e6;
        margin-bottom: 1rem;
    }

    .btn-reset-search {
        padding: 0.75rem 2rem;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        margin-top: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-reset-search:hover {
        background: #0b5ed7;
    }

    /* Animations */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Responsive Enhanced */
    @media (max-width: 991.98px) {
        .categories-grid {
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
        }
    }

    @media (max-width: 767.98px) {
        .breadcrumb-title {
            font-size: 1.5rem;
        }

        .filter-row {
            flex-direction: column;
            align-items: stretch;
        }

        .search-input-wrapper {
            width: 100%;
        }

        .sort-options {
            width: 100%;
            margin-top: 1rem;
        }

        .view-options {
            width: 100%;
            justify-content: center;
            margin-top: 1rem;
        }

        .categories-grid {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        }

        .categories-grid.list-view .category-card {
            flex-direction: column;
        }

        .categories-grid.list-view .category-image-wrapper {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<section class="breadcrumb-section">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'core:home' %}">{% trans "الرئيسية" %}</a></li>
                <li class="breadcrumb-item active" aria-current="page">{% trans "الفئات" %}</li>
            </ol>
        </nav>
        <h1 class="breadcrumb-title">{% trans "جميع الفئات" %}</h1>
    </div>
</section>

<!-- Filter, Sort and Search Bar -->
<section class="filter-search-section mb-4">
    <div class="container">
        <div class="filter-sort-bar">
            <div class="filter-row">
                <!-- Search Bar -->
                <div class="search-input-wrapper">
                    <input type="text"
                           class="search-input"
                           id="categorySearch"
                           placeholder="{% trans 'ابحث عن فئة...' %}"
                           aria-label="{% trans 'البحث في الفئات' %}">
                    <i class="fas fa-search search-icon"></i>
                    <button type="button" class="clear-search" id="clearSearch">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Sort Options -->
                <div class="sort-options">
                    <select class="sort-select" id="sortSelect">
                        <option value="name">{% trans "ترتيب حسب: الاسم (أ-ي)" %}</option>
                        <option value="name_desc">{% trans "ترتيب حسب: الاسم (ي-أ)" %}</option>
                        <option value="products">{% trans "ترتيب حسب: عدد المنتجات" %}</option>
                        <option value="newest">{% trans "ترتيب حسب: الأحدث" %}</option>
                        <option value="popular">{% trans "ترتيب حسب: الأكثر مشاهدة" %}</option>
                    </select>
                </div>

                <!-- View Toggle -->
                <div class="view-options">
                    <button class="view-btn active" data-view="grid" title="{% trans 'عرض شبكي' %}">
                        <i class="fas fa-th-large"></i>
                    </button>
                    <button class="view-btn" data-view="list" title="{% trans 'عرض قائمة' %}">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Featured Categories Section -->
{% if featured_categories %}
<section class="featured-categories-section">
    <div class="container">
        <h2 class="section-title">{% trans "الفئات المميزة" %}</h2>

        <div class="categories-grid" id="featuredCategoriesGrid">
            {% for category in featured_categories %}
                <div class="category-card"
                     data-name="{{ category.name }}"
                     data-products="{{ category.total_products }}"
                     data-views="{{ category.views_count }}"
                     data-date="{{ category.created_at|date:'U' }}"
                     style="animation-delay: {{ forloop.counter0 }}00ms">
                    <!-- Using image or icon -->
                    <div class="category-image-wrapper">
                        {% if category.image %}
                            <img src="{{ category.image.url }}"
                                 class="category-image"
                                 alt="{{ category.name }}"
                                 loading="lazy">
                        {% else %}
                            <div class="category-icon-wrapper">
                                <i class="fas fa-{{ category.icon|default:'cube' }} category-icon"></i>
                            </div>
                        {% endif %}
                        <div class="category-overlay"></div>
                    </div>

                    <span class="category-badge">
                        <i class="fas fa-star"></i>
                        {% trans "مميز" %}
                    </span>

                    {% if category.views_count > 1000 %}
                        <span class="view-count-badge">
                            <i class="fas fa-eye"></i>
                            {{ category.views_count|floatformat:0 }}
                        </span>
                    {% endif %}

                    <div class="category-content">
                        <h3 class="category-name">
                            <i class="fas fa-{{ category.icon|default:'folder' }} category-icon-inline"></i>
                            {{ category.name }}
                        </h3>

                        {% if category.description %}
                            <p class="category-description">{{ category.description|truncatechars:150 }}</p>
                        {% endif %}

                        <div class="category-stats">
                            <div class="product-count">
                                <i class="fas fa-box"></i>
                                <span>{{ category.total_products }} {% trans "منتج" %}</span>
                            </div>
                            <a href="{{ category.get_absolute_url }}" class="category-link">
                                {% trans "عرض المنتجات" %} <i class="fas fa-arrow-left"></i>
                            </a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- Main Categories Section -->
<section class="categories-section">
    <div class="container">
        <h2 class="section-title">{% trans "جميع الفئات" %}</h2>

        <div class="categories-grid" id="categoriesGrid">
            {% for category in categories %}
                <div class="category-card"
                     data-name="{{ category.name }}"
                     data-products="{{ category.total_products }}"
                     data-views="{{ category.views_count }}"
                     data-date="{{ category.created_at|date:'U' }}"
                     style="animation-delay: {{ forloop.counter0 }}00ms">
                    <!-- Using image or icon -->
                    <div class="category-image-wrapper">
                        {% if category.image %}
                            <img src="{{ category.image.url }}"
                                 class="category-image"
                                 alt="{{ category.name }}"
                                 loading="lazy">
                        {% else %}
                            <div class="category-icon-wrapper">
                                <i class="fas fa-{{ category.icon|default:'cube' }} category-icon"></i>
                            </div>
                        {% endif %}
                        <div class="category-overlay"></div>
                    </div>

                    {% if category.is_featured %}
                        <span class="category-badge">
                            <i class="fas fa-star"></i>
                            {% trans "مميز" %}
                        </span>
                    {% endif %}

                    {% if category.views_count > 1000 %}
                        <span class="view-count-badge">
                            <i class="fas fa-eye"></i>
                            {{ category.views_count|floatformat:0 }}
                        </span>
                    {% endif %}

                    <div class="category-content">
                        <h3 class="category-name">
                            <i class="fas fa-{{ category.icon|default:'folder' }} category-icon-inline"></i>
                            {{ category.name }}
                        </h3>

                        {% if category.description %}
                            <p class="category-description">{{ category.description|truncatechars:150 }}</p>
                        {% endif %}

                        <div class="category-stats">
                            <div class="product-count">
                                <i class="fas fa-box"></i>
                                <span>{{ category.total_products }} {% trans "منتج" %}</span>
                            </div>
                            <a href="{{ category.get_absolute_url }}" class="category-link">
                                {% trans "عرض المنتجات" %} <i class="fas fa-arrow-left"></i>
                            </a>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="col-12">
                    <div class="empty-state">
                        <i class="fas fa-folder-open empty-icon"></i>
                        <h3 class="empty-title">{% trans "لا توجد فئات" %}</h3>
                        <p class="empty-description">
                            {% trans "لم يتم إضافة أي فئات بعد." %}
                        </p>
                        <a href="{% url 'core:home' %}" class="btn btn-primary">
                            {% trans "العودة للرئيسية" %}
                        </a>
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- Empty Search Results State (Hidden by default) -->
        <div id="emptySearchState" class="empty-state" style="display: none;">
            <i class="fas fa-search empty-icon"></i>
            <h3 class="empty-title">{% trans "لا توجد نتائج" %}</h3>
            <p class="empty-description" id="emptySearchText">
                {% trans "لم نجد أي فئات تطابق بحثك" %}
            </p>
            <button class="btn-reset-search" id="resetSearchBtn">
                {% trans "إلغاء البحث" %}
            </button>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // تهيئة البحث في الفئات
    initializeCategorySearch();

    // تهيئة ترتيب الفئات
    initializeCategorySorting();

    // تهيئة تبديل طريقة العرض
    initializeViewModes();

    // دالة تهيئة البحث
    function initializeCategorySearch() {
        const searchInput = document.getElementById('categorySearch');
        const clearSearchBtn = document.getElementById('clearSearch');
        const resetSearchBtn = document.getElementById('resetSearchBtn');
        const categoryCards = document.querySelectorAll('.category-card');
        const featuredGrid = document.getElementById('featuredCategoriesGrid');
        const categoriesGrid = document.getElementById('categoriesGrid');
        const emptySearchState = document.getElementById('emptySearchState');
        const emptySearchText = document.getElementById('emptySearchText');

        if (!searchInput || !clearSearchBtn || !resetSearchBtn || !categoryCards.length) return;

        // البحث أثناء الكتابة
        searchInput.addEventListener('input', performSearch);

        // أزرار مسح البحث
        clearSearchBtn.addEventListener('click', clearSearch);
        resetSearchBtn.addEventListener('click', clearSearch);

        function performSearch() {
            const query = searchInput.value.trim().toLowerCase();
            if (!query) {
                clearSearch();
                return;
            }

            let visibleCount = 0;
            let featuredVisibleCount = 0;

            // البحث في كل الفئات
            categoryCards.forEach(card => {
                const categoryName = card.dataset.name.toLowerCase();
                const categoryDescription = card.querySelector('.category-description')?.textContent.toLowerCase() || '';
                const searchContent = categoryName + ' ' + categoryDescription;
                const isVisible = searchContent.includes(query);

                card.style.display = isVisible ? '' : 'none';

                if (isVisible) {
                    // إعادة تعيين تأخير الحركة لتأثير أفضل
                    card.style.animationDelay = `${visibleCount * 100}ms`;

                    if (card.parentElement === featuredGrid) {
                        featuredVisibleCount++;
                    } else {
                        visibleCount++;
                    }
                }
            });

            // إظهار أو إخفاء حالة نتائج البحث الفارغة
            if (visibleCount === 0 && featuredVisibleCount === 0) {
                emptySearchText.textContent = `{% trans "لم نجد أي فئات تطابق بحثك عن" %} "${query}"`;
                emptySearchState.style.display = 'block';
                categoriesGrid.style.display = 'none';
                if (featuredGrid) {
                    featuredGrid.style.display = 'none';
                }
            } else {
                emptySearchState.style.display = 'none';
                categoriesGrid.style.display = 'grid';
                if (featuredGrid) {
                    featuredGrid.style.display = visibleCount > 0 ? 'grid' : 'none';
                }
            }
        }

        function clearSearch() {
            searchInput.value = '';

            // إعادة عرض جميع الفئات
            categoryCards.forEach((card, index) => {
                card.style.display = '';
                card.style.animationDelay = `${index * 100}ms`;
            });

            // إخفاء حالة البحث الفارغة
            emptySearchState.style.display = 'none';
            categoriesGrid.style.display = 'grid';
            if (featuredGrid) {
                featuredGrid.style.display = 'grid';
            }
        }
    }

    // دالة تهيئة ترتيب الفئات
    function initializeCategorySorting() {
        const sortSelect = document.getElementById('sortSelect');
        const featuredGrid = document.getElementById('featuredCategoriesGrid');
        const categoriesGrid = document.getElementById('categoriesGrid');

        if (!sortSelect || !categoriesGrid) return;

        sortSelect.addEventListener('change', function() {
            const sortBy = this.value;

            // ترتيب الفئات الرئيسية
            const categoryCards = Array.from(categoriesGrid.querySelectorAll('.category-card'));
            sortCards(categoryCards, sortBy, categoriesGrid);

            // ترتيب الفئات المميزة إذا وجدت
            if (featuredGrid) {
                const featuredCards = Array.from(featuredGrid.querySelectorAll('.category-card'));
                sortCards(featuredCards, sortBy, featuredGrid);
            }
        });

        function sortCards(cards, sortBy, container) {
            cards.sort((a, b) => {
                switch(sortBy) {
                    case 'name':
                        return a.dataset.name.localeCompare(b.dataset.name);
                    case 'name_desc':
                        return b.dataset.name.localeCompare(a.dataset.name);
                    case 'products':
                        return parseInt(b.dataset.products) - parseInt(a.dataset.products);
                    case 'newest':
                        return parseInt(b.dataset.date || 0) - parseInt(a.dataset.date || 0);
                    case 'popular':
                        return parseInt(b.dataset.views || 0) - parseInt(a.dataset.views || 0);
                    default:
                        return 0;
                }
            });

            // إعادة ترتيب البطاقات وتحديث تأخير الحركة
            cards.forEach((card, index) => {
                card.style.animationDelay = `${index * 100}ms`;
                container.appendChild(card);
            });
        }
    }

    // دالة تهيئة تبديل طريقة العرض
    function initializeViewModes() {
        const viewButtons = document.querySelectorAll('.view-btn');
        const featuredGrid = document.getElementById('featuredCategoriesGrid');
        const categoriesGrid = document.getElementById('categoriesGrid');

        if (!viewButtons.length || !categoriesGrid) return;

        // استرجاع نمط العرض المحفوظ
        const savedView = localStorage.getItem('categoryViewPreference');
        if (savedView) {
            setViewMode(savedView);
        }

        // إضافة معالج الحدث للنقر على أزرار تغيير العرض
        viewButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const viewMode = this.dataset.view;
                setViewMode(viewMode);
                localStorage.setItem('categoryViewPreference', viewMode);
            });
        });

        function setViewMode(mode) {
            // تحديث حالة الأزرار
            viewButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === mode);
            });

            // تحديث شبكات الفئات
            if (mode === 'list') {
                categoriesGrid.classList.add('list-view');
                if (featuredGrid) {
                    featuredGrid.classList.add('list-view');
                }
            } else {
                categoriesGrid.classList.remove('list-view');
                if (featuredGrid) {
                    featuredGrid.classList.remove('list-view');
                }
            }
        }
    }
});
</script>
{% endblock %}