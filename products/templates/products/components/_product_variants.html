{% load i18n %}

{% if product.variants.exists %}
<div class="product-variants" data-product-id="{{ product.id }}">
    <h5 class="mb-3">{% trans "اختر المتغير المناسب" %}</h5>

    <!-- جدول متغيرات المنتج -->
    <div class="variants-table-container">
        <table class="table table-hover variants-table">
            <thead>
                <tr>
                    <th>{% trans "اختيار" %}</th>
                    {% if product.variants.first.color %}
                    <th>{% trans "اللون" %}</th>
                    {% endif %}
                    {% if product.variants.first.size %}
                    <th>{% trans "المقاس" %}</th>
                    {% endif %}
                    {% if product.variants.first.material %}
                    <th>{% trans "المادة" %}</th>
                    {% endif %}
                    <th>{% trans "السعر" %}</th>
                    <th>{% trans "التوفر" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for variant in product.variants.all %}
                <tr class="variant-row {% if not variant.is_in_stock %}out-of-stock{% endif %}"
                    data-variant-id="{{ variant.id }}"
                    data-price="{{ variant.current_price }}"
                    data-stock="{{ variant.stock_quantity }}"
                    data-sku="{{ variant.sku }}">
                    <td>
                        <div class="form-check">
                            <input class="form-check-input variant-selector"
                                   type="radio"
                                   name="variant-option"
                                   id="variant-{{ variant.id }}"
                                   value="{{ variant.id }}"
                                   {% if forloop.first and variant.is_in_stock %}checked{% endif %}
                                   {% if not variant.is_in_stock %}disabled{% endif %}>
                            <label class="form-check-label" for="variant-{{ variant.id }}">
                                {% trans "اختر" %}
                            </label>
                        </div>
                    </td>
                    {% if variant.color %}
                    <td>
                        <div class="d-flex align-items-center">
                            {% if variant.color_code %}
                            <span class="color-box me-2" style="background-color: {{ variant.color_code }}"></span>
                            {% endif %}
                            {{ variant.get_color_display }}
                        </div>
                    </td>
                    {% endif %}
                    {% if variant.size %}
                    <td>{{ variant.get_size_display }}</td>
                    {% endif %}
                    {% if variant.material %}
                    <td>{{ variant.material }}</td>
                    {% endif %}
                    <td class="fw-bold">{{ variant.current_price }} {% trans "د.أ" %}</td>
                    <td>
                        {% if variant.is_in_stock %}
                        <span class="badge bg-success">{% trans "متوفر" %}</span>
                        {% if variant.stock_quantity %}
                        <small class="text-muted">({{ variant.stock_quantity }})</small>
                        {% endif %}
                        {% else %}
                        <span class="badge bg-danger">{% trans "نفذ" %}</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- معلومات المتغير المحدد -->
    <div class="selected-variant-info mt-4 p-3 border rounded" id="variantInfo">
        <h6 class="fw-bold">{% trans "تفاصيل المتغير المحدد" %}</h6>
        <div class="row">
            <div class="col-md-4">
                <small class="text-muted">{% trans "رقم المنتج" %}</small>
                <div class="fw-bold" id="selectedVariantSku">-</div>
            </div>
            <div class="col-md-4">
                <small class="text-muted">{% trans "السعر" %}</small>
                <div class="fw-bold text-success" id="selectedVariantPrice">-</div>
            </div>
            <div class="col-md-4">
                <small class="text-muted">{% trans "المتوفر" %}</small>
                <div class="fw-bold" id="selectedVariantStock">-</div>
            </div>
        </div>
    </div>
</div>

<style>
.variants-table-container {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 1rem;
}

.variants-table {
    position: relative;
}

.variants-table thead th {
    position: sticky;
    top: 0;
    background-color: #fff;
    z-index: 10;
}

.variant-row {
    cursor: pointer;
    transition: all 0.2s ease;
}

.variant-row:hover:not(.out-of-stock) {
    background-color: rgba(var(--bs-primary-rgb), 0.05);
}

.variant-row.selected {
    background-color: rgba(var(--bs-primary-rgb), 0.1);
}

.variant-row.out-of-stock {
    opacity: 0.6;
    background-color: rgba(0,0,0,0.03);
}

.color-box {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: inline-block;
    border: 1px solid #ddd;
}

.selected-variant-info {
    background-color: rgba(var(--bs-primary-rgb), 0.05);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // متغيرات عامة
    const variantContainer = document.querySelector('.product-variants');
    if (!variantContainer) return;

    const variantRows = document.querySelectorAll('.variant-row');
    const variantSelectors = document.querySelectorAll('.variant-selector');
    const variantForm = document.getElementById('addToCartForm');
    const selectedVariantIdField = document.getElementById('selectedVariantId');

    // عناصر معلومات المتغير المحدد
    const selectedVariantSku = document.getElementById('selectedVariantSku');
    const selectedVariantPrice = document.getElementById('selectedVariantPrice');
    const selectedVariantStock = document.getElementById('selectedVariantStock');

    // تحديث معلومات المتغير المحدد
    function updateSelectedVariantInfo(variantRow) {
        const variantId = variantRow.dataset.variantId;
        const price = variantRow.dataset.price;
        const stock = variantRow.dataset.stock;
        const sku = variantRow.dataset.sku;

        // تحديث الحقل المخفي
        if (selectedVariantIdField) {
            selectedVariantIdField.value = variantId;
        }

        // تحديث معلومات العرض
        if (selectedVariantSku) selectedVariantSku.textContent = sku || '-';
        if (selectedVariantPrice) selectedVariantPrice.textContent = `${price} د.أ`;

        if (selectedVariantStock) {
            const stockNum = parseInt(stock);
            if (stockNum > 10) {
                selectedVariantStock.textContent = 'متوفر';
                selectedVariantStock.className = 'fw-bold text-success';
            } else if (stockNum > 0) {
                selectedVariantStock.textContent = `${stockNum} قطعة فقط`;
                selectedVariantStock.className = 'fw-bold text-warning';
            } else {
                selectedVariantStock.textContent = 'نفذ من المخزون';
                selectedVariantStock.className = 'fw-bold text-danger';
            }
        }

        // إزالة الفئة selected من جميع الصفوف
        variantRows.forEach(row => row.classList.remove('selected'));

        // إضافة الفئة selected إلى الصف المحدد
        variantRow.classList.add('selected');
    }

    // تحديث حالة الزر "إضافة إلى السلة" بناء على توفر المتغير
    function updateAddToCartButton() {
        const addToCartBtn = document.querySelector('.btn-add-to-cart');
        const selectedVariant = document.querySelector('.variant-selector:checked');

        if (!addToCartBtn) return;

        if (selectedVariant) {
            const variantRow = selectedVariant.closest('.variant-row');
            const isInStock = !variantRow.classList.contains('out-of-stock');

            addToCartBtn.disabled = !isInStock;

            if (isInStock) {
                addToCartBtn.innerHTML = '<i class="fas fa-shopping-cart me-2"></i>إضافة إلى السلة';
                addToCartBtn.classList.remove('btn-secondary');
                addToCartBtn.classList.add('btn-add-to-cart');
            } else {
                addToCartBtn.innerHTML = '<i class="fas fa-times-circle me-2"></i>غير متوفر حالياً';
                addToCartBtn.classList.remove('btn-add-to-cart');
                addToCartBtn.classList.add('btn-secondary');
            }
        }
    }

    // معالجة النقر على صف المتغير
    variantRows.forEach(row => {
        row.addEventListener('click', function() {
            // تفعيل زر الاختيار إذا كان المتغير متوفراً
            if (!this.classList.contains('out-of-stock')) {
                const selector = this.querySelector('.variant-selector');
                if (selector) {
                    selector.checked = true;
                    updateSelectedVariantInfo(this);
                    updateAddToCartButton();
                }
            }
        });
    });

    // معالجة تغيير زر الاختيار
    variantSelectors.forEach(selector => {
        selector.addEventListener('change', function() {
            if (this.checked) {
                const variantRow = this.closest('.variant-row');
                updateSelectedVariantInfo(variantRow);
                updateAddToCartButton();
            }
        });
    });

    // التحقق من النموذج قبل الإرسال
    if (variantForm) {
        variantForm.addEventListener('submit', function(e) {
            // التحقق من اختيار متغير إذا كانت هناك متغيرات
            if (variantContainer && !selectedVariantIdField.value) {
                e.preventDefault();
                alert('الرجاء اختيار متغير المنتج');
                return false;
            }
            return true;
        });
    }

    // تهيئة المتغير الافتراضي عند تحميل الصفحة
    const defaultVariant = document.querySelector('.variant-selector:checked');
    if (defaultVariant) {
        const variantRow = defaultVariant.closest('.variant-row');
        updateSelectedVariantInfo(variantRow);
        updateAddToCartButton();
    }
});
</script>
{% endif %}